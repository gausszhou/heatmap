(function(c,g){typeof exports=="object"&&typeof module<"u"?module.exports=g():typeof define=="function"&&define.amd?define(g):(c=typeof globalThis<"u"?globalThis:c||self,c.h337=g())})(this,function(){"use strict";const c={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}};var g=function(t){var e=t.gradient||t.defaultGradient,a=document.createElement("canvas"),r=a.getContext("2d");if(!r)return!1;a.width=256,a.height=1;const i=r.createLinearGradient(0,0,256,1);for(var n in e)i.addColorStop(Number(n),e[n]);return r.fillStyle=i,r.fillRect(0,0,256,1),r.getImageData(0,0,256,1).data},D=function(t,e){var a=document.createElement("canvas"),r=a.getContext("2d");if(!r)return!1;var i=t,n=t;if(a.width=a.height=t*2,e==1)r.beginPath(),r.arc(i,n,t,0,2*Math.PI,!1),r.fillStyle="rgba(0,0,0,1)",r.fill();else{var s=r.createRadialGradient(i,n,t*e,i,n,t);s.addColorStop(0,"rgba(0,0,0,1)"),s.addColorStop(1,"rgba(0,0,0,0)"),r.fillStyle=s,r.fillRect(0,0,2*t,2*t)}return a},b=function(n){for(var e=[],a=n.min,r=n.max,i=n.radi,n=n.data,s=Object.keys(n),l=s.length;l--;)for(var d=s[l],o=Object.keys(n[d]),h=o.length;h--;){var v=o[h],u=n[d][v],_=i[d][v];e.push({x:d,y:v,value:u,radius:_})}return{min:a,max:r,data:e}};function x(t){var e=t.container,a=this.shadowCanvas=document.createElement("canvas"),r=this.canvas=t.canvas||document.createElement("canvas");this._renderBoundaries=[1e4,1e4,0,0];var i=getComputedStyle(t.container)||{};r.className="heatmap-canvas",this._width=r.width=a.width=t.width||+i.width.replace(/px/,""),this._height=r.height=a.height=t.height||+i.height.replace(/px/,""),this.shadowCtx=a.getContext("2d"),this.ctx=r.getContext("2d"),r.style.cssText=a.style.cssText="position:absolute;left:0;top:0;",e.style.position="relative",e.appendChild(r),this._palette=g(t),this._templates={},this._setStyles(t)}x.prototype={renderPartial:function(t){t.data.length>0&&(this._drawAlpha(t),this._colorize())},renderAll:function(t){this._clear(),t.data.length>0&&(this._drawAlpha(b(t)),this._colorize())},_updateGradient:function(t){this._palette=g(t)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=t.blur==0?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=t.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=t.height||this._height,this._opacity=(t.opacity||0)*255,this._maxOpacity=(t.maxOpacity||t.defaultMaxOpacity)*255,this._minOpacity=(t.minOpacity||t.defaultMinOpacity)*255,this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(r){for(var e=this._min=r.min,a=this._max=r.max,r=r.data||[],i=r.length,n=1-this._blur;i--;){var s=r[i],l=s.x,d=s.y,o=s.radius,h=Math.min(s.value,a),v=l-o,u=d-o,_=this.shadowCtx,m;this._templates[o]?m=this._templates[o]:this._templates[o]=m=D(o,n);var f=(h-e)/(a-e);_.globalAlpha=f<.01?.01:f,_.drawImage(m,v,u),v<this._renderBoundaries[0]&&(this._renderBoundaries[0]=v),u<this._renderBoundaries[1]&&(this._renderBoundaries[1]=u),v+2*o>this._renderBoundaries[2]&&(this._renderBoundaries[2]=v+2*o),u+2*o>this._renderBoundaries[3]&&(this._renderBoundaries[3]=u+2*o)}},_colorize:function(){var t=this._renderBoundaries[0],e=this._renderBoundaries[1],a=this._renderBoundaries[2]-t,r=this._renderBoundaries[3]-e,i=this._width,n=this._height,s=this._opacity,l=this._maxOpacity,d=this._minOpacity,o=this._useGradientOpacity;t<0&&(t=0),e<0&&(e=0),t+a>i&&(a=i-t),e+r>n&&(r=n-e);for(var h=this.shadowCtx.getImageData(t,e,a,r),v=h.length,u=this._palette,_=3;_<v;_+=4){var m=h[_],f=m*4;if(f){var p;s>0?p=s:m<l?m<d?p=d:p=m:p=l,h[_-3]=u[f],h[_-2]=u[f+1],h[_-1]=u[f+2],h[_]=o?u[f+3]:p}}this.ctx.putImageData(h,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var e,a=this.shadowCtx,r=a.getImageData(t.x,t.y,1,1),i=r.data[3],n=this._max,s=this._min;return e=Math.abs(n-s)*(i/255)>>0,e},getDataURL:function(){return this.canvas.toDataURL()}};const O=function(){let e=!1;return c.defaultRenderer==="canvas2d"&&(e=x),e}(),{defaultRadius:F}=c;function y(t){this._coordinator={},this._data=[],this._radi=[],this._min=10,this._max=1,this._xField=t.xField||t.defaultXField,this._yField=t.yField||t.defaultYField,this._valueField=t.valueField||t.defaultValueField,t.radius&&(this._cfgRadius=t.radius)}y.prototype={_organiseData:function(t,e){var a=t[this._xField],r=t[this._yField],i=this._radi,n=this._data,s=this._max,l=this._min,d=t[this._valueField]||1,o=t.radius||this._cfgRadius||F;n[a]||(n[a]=[],i[a]=[]),n[a][r]?n[a][r]+=d:(n[a][r]=d,i[a][r]=o);var h=n[a][r];return h>s?(e?this.setDataMax(h):this._max=h,!1):h<l?(e?this.setDataMin(h):this._min=h,!1):{x:a,y:r,value:d,radius:o,min:l,max:s}},_unOrganizeData:function(){var t=[],e=this._data,a=this._radi;for(var r in e)for(var i in e[r])t.push({x:r,y:i,radius:a[r][i],value:e[r][i]});return{min:this._min,max:this._max,data:t}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var t=arguments[0],e=t.length;e--;)this.addData.call(this,t[e]);else{var a=this._organiseData(arguments[0],!0);a&&(this._data.length===0&&(this._min=this._max=a.value),this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[a]}))}return this},setData:function(t){var e=t.data,a=e.length;this._data=[],this._radi=[];for(var r=0;r<a;r++)this._organiseData(e[r],!1);return this._max=t.max,this._min=t.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(t){return this._max=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(t){return this._min=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(t){this._coordinator=t},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}};class w{static merge(...e){for(var a={},r=e.length,i=0;i<r;i++){var n=e[i];for(var s in n)a[s]=n[s]}return a}}var R=function(){function e(){this.cStore={}}return e.prototype={on:function(a,r,i){var n=this.cStore;n[a]||(n[a]=[]),n[a].push(function(s){return r.call(i,s)})},emit:function(a,r){var i=this.cStore;if(i[a])for(var n=i[a].length,s=0;s<n;s++){var l=i[a][s];l(r)}}},e}(),B=function(t){var e=t._renderer,a=t._coordinator,r=t._store;a.on("renderpartial",e.renderPartial,e),a.on("renderall",e.renderAll,e),a.on("extremachange",function(i){t._config.onExtremaChange&&t._config.onExtremaChange({min:i.min,max:i.max,gradient:t._config.gradient||t._config.defaultGradient})}),r.setCoordinator(a)};function C(){var t=this._config=w.merge(c,arguments[0]||{});if(this._coordinator=new R,t.plugin){var e=t.plugin;if(c.plugins[e]){var a=c.plugins[e];this._renderer=new a.renderer(t),this._store=new a.store(t)}else throw new Error("Plugin '"+e+"' not found. Maybe it was not registered.")}else this._renderer=new O(t),this._store=new y(t);B(this)}return C.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(t){return this._config=w.merge(this._config,t),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(t){return this._store.getValueAt?this._store.getValueAt(t):this._renderer.getValueAt?this._renderer.getValueAt(t):null}},{create:function(t){return new C(t)},register:function(t,e){c.plugins[t]=e}}});
